name: Train KTO Titanic model and Deploy API

on:
  push:
    branches:
      - main
    paths:
      - 'src/titanic/api/**'
      - 'src/titanic/training/**'
      - 'src/titanic/ci/**'
      - '/tests/api/**'
      - '/tests/training/**'
      - '/tests/ci/**'
      - 'k8s/experiment/**'
      - 'k8s/api/**'
      - '.github/workflows/ct-ci-cd.yaml'
  pull_request:
    branches:
      - main

env:
  EXPERIMENT_NAME: kto-titanic
  EXPERIMENT_IMAGE_NAME: quay.io/{{ cookiecutter.quay_username }}/titanic/experiment
  API_IMAGE_NAME: quay.io/{{ cookiecutter.quay_username }}/titanic/api
  API_ROUTE_NAME: titanic-api
  DAILYCLEAN_ROUTE_NAME: dailyclean
  MINIO_API_ROUTE_NAME: minio-api
  MLFLOW_TRACKING_ROUTE_NAME: mlflow

jobs:
  train:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python {{ cookiecutter.python_version }}
        uses: actions/setup-python@v3
        with:
          python-version: {{ cookiecutter.python_version }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install uv
          uv sync --group training --group api --group dev
      - name: Launch unit tests
        run: |
          uv run pytest tests/api tests/ci tests/training
      - name: Resync only training group
        run: |
          uv sync --group training
      - name: Configure docker and kubectl
        run: |
          docker login -u="{{ "${{" }}vars.QUAY_ROBOT_USERNAME}}" -p="{{ "${{" }}secrets.QUAY_ROBOT_TOKEN}}" quay.io
          kubectl config set-cluster openshift-cluster --server={{ "${{" }}vars.OPENSHIFT_SERVER}}
          kubectl config set-credentials openshift-credentials --token={{ "${{" }}secrets.OPENSHIFT_TOKEN}}
          kubectl config set-context openshift-context --cluster=openshift-cluster --user=openshift-credentials --namespace={{ "${{" }}vars.OPENSHIFT_USERNAME}}-dev
          kubectl config use openshift-context
      - name: Get Routes from Kubernetes and add them to env
        run: |
          DAILYCLEAN_ROUTE_URL=$(kubectl get route {{ "${{" }} env.DAILYCLEAN_ROUTE_NAME }} -o jsonpath='{.spec.host}')
          MINIO_API_ROUTE_URL=$(kubectl get route {{ "${{" }} env.MINIO_API_ROUTE_NAME }} -o jsonpath='{.spec.host}')
          MLFLOW_TRACKING_ROUTE_URL=$(kubectl get route {{ "${{" }} env.MLFLOW_TRACKING_ROUTE_NAME }} -o jsonpath='{.spec.host}')
          echo "DAILYCLEAN_ROUTE_URL=https://$DAILYCLEAN_ROUTE_URL" >> "$GITHUB_ENV"
          echo "MINIO_API_ROUTE_URL=https://$MINIO_API_ROUTE_URL" >> "$GITHUB_ENV"
          echo "MLFLOW_TRACKING_ROUTE_URL=https://$MLFLOW_TRACKING_ROUTE_URL" >> "$GITHUB_ENV"
      - name: Wake up dailyclean and mlflow
        run: |
          kubectl scale --replicas=1 deployment/dailyclean-api
          sleep 30
          curl -X POST $DAILYCLEAN_ROUTE_URL/pods/start
      - name: Build training image
        run: |
          docker build -f k8s/experiment/Dockerfile -t {{ "${{" }} env.EXPERIMENT_IMAGE_NAME }}:latest --build-arg MLFLOW_S3_ENDPOINT_URL=$MINIO_API_ROUTE_URL --build-arg AWS_ACCESS_KEY_ID={{ "${{" }}vars.AWS_ACCESS_KEY_ID}} --build-arg AWS_SECRET_ACCESS_KEY={{ "${{" }}secrets.AWS_SECRET_ACCESS_KEY}} .
      - name: Launch mlflow training in Openshift
        run: |
          export KUBE_MLFLOW_TRACKING_URI=$MLFLOW_TRACKING_ROUTE_URL
          export MLFLOW_TRACKING_URI=$MLFLOW_TRACKING_ROUTE_URL
          export MLFLOW_S3_ENDPOINT_URL=$MINIO_API_ROUTE_URL
          export AWS_ACCESS_KEY_ID="{{ "${{" }}vars.AWS_ACCESS_KEY_ID}}" 
          export AWS_SECRET_ACCESS_KEY="{{ "${{" }}secrets.AWS_SECRET_ACCESS_KEY}}"
          
          uv run mlflow run ./src/titanic/training -P path=all_titanic.csv --experiment-name {{ "${{" }} env.EXPERIMENT_NAME }} --backend kubernetes --backend-config ./k8s/experiment/kubernetes_config.json

      - name: Download model artifact
        run: |
          export MLFLOW_TRACKING_URI=$MLFLOW_TRACKING_ROUTE_URL
          export MLFLOW_S3_ENDPOINT_URL=$MINIO_API_ROUTE_URL
          export AWS_ACCESS_KEY_ID="{{ "${{" }}vars.AWS_ACCESS_KEY_ID}}" 
          export AWS_SECRET_ACCESS_KEY="{{ "${{" }}secrets.AWS_SECRET_ACCESS_KEY}}"
          export ARTIFACT_URI=$(uv run -m titanic.ci.search_mlflow --experiment-name {{ "${{" }} env.EXPERIMENT_NAME }})
          
          echo "ARTIFACT_URI=$ARTIFACT_URI"
          uv run mlflow artifacts download --artifact-uri $ARTIFACT_URI -d ./src/titanic/api/resources/
          
          # could be : uv run mlflow artifacts download -r $MLFLOW_RUN_ID -a model.pkl -d ./src/titanic/api/resources/
      - name: Build and push api image
        run: |
          docker build -f k8s/api/Dockerfile -t {{ "${{" }} env.API_IMAGE_NAME }}:latest .
          docker push {{ "${{" }} env.API_IMAGE_NAME }}:latest
      - name: Configure API manifest with OAuth2 domain
        run: |
          sed -i 's|PLACEHOLDER_OAUTH2_DOMAIN|{{ "${{" }} vars.OAUTH2_DOMAIN }}|g' k8s/api/api.yaml
          echo "âœ… OAuth2 domain configured: {{ "${{" }} vars.OAUTH2_DOMAIN }}"
      - name: Deploy api to Openshift with OAuth2 protection
        run: |
          kubectl apply -f k8s/api/api.yaml
          echo "âœ… Deployment updated with OAuth2 protection"
          API_ROUTE_URL=$(kubectl get route {{ "${{" }} env.API_ROUTE_NAME }} -o jsonpath='{.spec.host}')
          echo "API_ROUTE_URL=https://$API_ROUTE_URL" >> "$GITHUB_ENV"
          echo "ðŸš€ API deployed at: ${API_ROUTE_URL}"
      - name: Get OAuth2 token for integration test
        run: |
          TOKEN_RESPONSE=$(curl -s -X POST "https://{{ "${{" }} vars.OAUTH2_DOMAIN }}/oauth/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=client_credentials" \
            -d "client_id={{ "${{" }} secrets.OAUTH2_CLIENT_ID }}" \
            -d "client_secret={{ "${{" }} secrets.OAUTH2_CLIENT_SECRET }}" \
            -d "audience=titanic-api" \
            -d "scope=api:read")
          ACCESS_TOKEN=$(echo $TOKEN_RESPONSE | jq -r '.access_token')
          echo "ACCESS_TOKEN=$ACCESS_TOKEN" >> "$GITHUB_ENV"
          echo "âœ… OAuth2 token obtained for testing"
      - name: Test api with OAuth2 authentication
        run: |
          sleep 60
          curl -X POST $API_ROUTE_URL/infer \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -d '{"pclass": 3, "sex": "male", "sibSp": 0, "parch": 0}'
          echo "âœ… Integration test passed with OAuth2"
      - name: Asleep kto-mlflow with dailyclean
        run: |
          curl -X POST $DAILYCLEAN_ROUTE_URL/pods/stop
