name: Deploy MCP Server

on:
  push:
    branches:
      - main
    paths:
      - 'src/titanic/mcp_server/**'
      - '/tests/mcp_server/**'
      - 'k8s/mcp_server/**'
      - '.github/workflows/deploy-mcp-server.yml'
  workflow_dispatch:

env:
  MCP_SERVER_IMAGE_NAME: quay.io/{{ cookiecutter.quay_username }}/titanic/mcp-server
  MCP_SERVER_DEPLOYMENT_NAME: titanic-mcp-server
  MCP_SERVER_SECRET_NAME: mcp-oauth2-credentials

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python {{ cookiecutter.python_version }}
        uses: actions/setup-python@v3
        with:
          python-version: {{ cookiecutter.python_version }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install uv
          uv sync --group mcp-server
      - name: Launch unit tests
        run: |
          uv run pytest tests/mcp_server

      - name: Configure docker and kubectl
        run: |
          docker login -u="{{ "${{" }}vars.QUAY_ROBOT_USERNAME}}" -p="{{ "${{" }}secrets.QUAY_ROBOT_TOKEN}}" quay.io
          kubectl config set-cluster openshift-cluster --server={{ "${{" }}vars.OPENSHIFT_SERVER}}
          kubectl config set-credentials openshift-credentials --token={{ "${{" }}secrets.OPENSHIFT_TOKEN}}
          kubectl config set-context openshift-context --cluster=openshift-cluster --user=openshift-credentials --namespace={{ "${{" }}vars.OPENSHIFT_USERNAME}}-dev
          kubectl config use openshift-context

      - name: Build and push Docker image
        run: |
          docker build -f k8s/mcp_server/Dockerfile -t {{ "${{" }} env.MCP_SERVER_IMAGE_NAME }}:latest .
          docker push {{ "${{" }} env.MCP_SERVER_IMAGE_NAME }}:latest

      - name: Create OAuth2 secret
        run: |
          if kubectl get secret {{ "${{" }} env.MCP_SERVER_SECRET_NAME }} &>/dev/null; then
            kubectl delete secret {{ "${{" }} env.MCP_SERVER_SECRET_NAME }}
          fi
          kubectl create secret generic {{ "${{" }} env.MCP_SERVER_SECRET_NAME }} \
            --from-literal=client-id="{{ "${{" }} secrets.OAUTH2_CLIENT_ID }}" \
            --from-literal=client-secret="{{ "${{" }} secrets.OAUTH2_CLIENT_SECRET }}" \
            --dry-run=client -o yaml | kubectl apply -f -
          echo "âœ… OAuth2 credentials secret created/updated"

      - name: Delete MCP Server pod to refresh secret
        run: |
          POD=$(kubectl get pods -l app={{ "${{" }} env.MCP_SERVER_DEPLOYMENT_NAME }} -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)
          if [ -n "$POD" ]; then
            kubectl delete pod $POD
            echo "âœ… Pod {{ "${{" }} env.MCP_SERVER_DEPLOYMENT_NAME }} supprimÃ©, il va Ãªtre recrÃ©Ã© avec le secret Ã  jour"
          else
            echo "âš ï¸ Aucun pod {{ "${{" }} env.MCP_SERVER_DEPLOYMENT_NAME }} trouvÃ© Ã  supprimer (premier dÃ©ploiement)"
          fi

      - name: Configure MCP manifest with OAuth2 domain
        run: |
          sed -i 's|PLACEHOLDER_OAUTH2_DOMAIN|{{ "${{" }} vars.OAUTH2_DOMAIN }}|g' k8s/mcp_server/mcp-server.yaml
          echo "âœ… OAuth2 domain configured: {{ "${{" }} vars.OAUTH2_DOMAIN }}"

      - name: Deploy to OpenShift
        run: |
          kubectl apply -f k8s/mcp_server/mcp-server.yaml
          echo "âœ… MCP Server deployment updated"
          echo "## ðŸ”§ MCP Server Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status**: Deployed successfully" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Image**: {{ "${{" }} env.MCP_SERVER_IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
