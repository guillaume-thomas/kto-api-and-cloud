name: Deploy Titanic Chatbot

on:
  push:
    branches:
      - main
    paths:
      - 'src/titanic/chatbot/**'
      - '/tests/chatbot/**'
      - 'k8s/chatbot/**'
      - '.github/workflows/deploy-chatbot.yml'
  workflow_dispatch:

env:
  CHATBOT_IMAGE_NAME: quay.io/{{ cookiecutter.quay_username }}/titanic/chatbot
  CHATBOT_DEPLOYMENT_NAME: titanic-chatbot
  CHATBOT_SECRET_NAME: chatbot-secrets
  CHATBOT_ROUTE_NAME: titanic-chatbot

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python {{ cookiecutter.python_version }}
        uses: actions/setup-python@v3
        with:
          python-version: {{ cookiecutter.python_version }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install uv
          uv sync --group chatbot
      - name: Launch unit tests
        run: |
          uv run pytest tests/chatbot

      - name: Configure docker and kubectl
        run: |
          docker login -u="{{ "${{" }}vars.QUAY_ROBOT_USERNAME}}" -p="{{ "${{" }}secrets.QUAY_ROBOT_TOKEN}}" quay.io
          kubectl config set-cluster openshift-cluster --server={{ "${{" }}vars.OPENSHIFT_SERVER}}
          kubectl config set-credentials openshift-credentials --token={{ "${{" }}secrets.OPENSHIFT_TOKEN}}
          kubectl config set-context openshift-context --cluster=openshift-cluster --user=openshift-credentials --namespace={{ "${{" }}vars.OPENSHIFT_USERNAME}}-dev
          kubectl config use openshift-context

      - name: Build and push Docker image
        run: |
          docker build -f k8s/chatbot/Dockerfile -t {{ "${{" }} env.CHATBOT_IMAGE_NAME }}:latest .
          docker push {{ "${{" }} env.CHATBOT_IMAGE_NAME }}:latest

      - name: Create or update Secret
        run: |
          if kubectl get secret {{ "${{" }} env.CHATBOT_SECRET_NAME }} 2>/dev/null; then
            echo "Secret exists, updating..."
            kubectl delete secret {{ "${{" }} env.CHATBOT_SECRET_NAME }}
          fi
          kubectl create secret generic {{ "${{" }} env.CHATBOT_SECRET_NAME }} \
            --from-literal=github-models-token="{{ "${{" }} secrets.GH_MODELS_TOKEN }}"
          echo "âœ… Secret created/updated"

      - name: Delete Chatbot pod to refresh secret
        run: |
          POD=$(kubectl get pods -l app={{ "${{" }} env.CHATBOT_DEPLOYMENT_NAME }} -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)
          if [ -n "$POD" ]; then
            kubectl delete pod $POD
            echo "âœ… Pod {{ "${{" }} env.CHATBOT_DEPLOYMENT_NAME }} supprimÃ©, il va Ãªtre recrÃ©Ã© avec le secret Ã  jour"
          else
            echo "âš ï¸ Aucun pod {{ "${{" }} env.CHATBOT_DEPLOYMENT_NAME }} trouvÃ© Ã  supprimer (premier dÃ©ploiement)"
          fi

      - name: Deploy to OpenShift
        run: |
          kubectl apply -f k8s/chatbot/chatbot.yaml
          echo "âœ… Deployment updated"

      - name: Get route URL
        run: |
          ROUTE_URL=$(kubectl get route {{ "${{" }} env.CHATBOT_ROUTE_NAME }} -o jsonpath='{.spec.host}')
          echo "ðŸš€ Chatbot deployed at: https://${ROUTE_URL}"
          echo "## ðŸš¢ Titanic Chatbot Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status**: Deployed successfully" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **URL**: https://${ROUTE_URL}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Image**: {{ "${{" }} env.CHATBOT_IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” **Secret**: {{ "${{" }} env.CHATBOT_SECRET_NAME }} updated" >> $GITHUB_STEP_SUMMARY
